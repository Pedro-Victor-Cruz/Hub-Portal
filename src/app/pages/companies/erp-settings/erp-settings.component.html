<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <div class="p-fluid p-formgrid grid">

    <div class="col-12 md:col-6">
      <ub-dropdown
        [options]="optionsErpName"
        label="ERP"
        placeholder="Selecione o ERP"
        formControlName="erp_name"
        [error]="FormErrorHandlerService.getError('erp_name', errors)"
      ></ub-dropdown>
    </div>

    <div class="col-12 md:col-6">
      <ub-dropdown
        [options]="optionsAuthType"
        label="Tipo de Autenticação"
        placeholder="Selecione o tipo de autenticação"
        formControlName="auth_type"
        [error]="FormErrorHandlerService.getError('auth_type', errors)"
      ></ub-dropdown>
    </div>

    <div class="col-12 md:col-6">
      <ub-input
        label="Username"
        placeholder="Digite o username de login"
        helpText="Digite o username que será utilizado para login caso houver"
        formControlName="username"
        [error]="FormErrorHandlerService.getError('username', errors)"
      ></ub-input>
    </div>

    <div class="col-12 md:col-6">
      <ub-password
        label="Senha (Secret-Key)"
        placeholder="Digite a senha de login"
        helpText="Digite a senha que será utilizada para login caso houver"
        formControlName="secret_key"
        [error]="FormErrorHandlerService.getError('secret_key', errors)"
      ></ub-password>
    </div>

    <div class="col-12 md:col-6">
      <ub-input
        label="URL Base (Host)"
        placeholder="Digite a URL base do ERP"
        helpText="Digite a URL base do ERP, ex: https://erp.exemplo.com"
        formControlName="base_url"
        [error]="FormErrorHandlerService.getError('base_url', errors)"
      ></ub-input>
    </div>

    <div class="col-12 md:col-6">
      <ub-input
        label="Token de Acesso"
        placeholder="Digite o token de acesso"
        helpText="Digite o token de acesso do ERP, utilizado para autenticação"
        formControlName="token"
        [error]="FormErrorHandlerService.getError('token', errors)"
      ></ub-input>
    </div>

  </div>

  <!-- Botão de Salvar -->
  <div class="flex justify-content-end gap-2">
    <ub-button type="button" (click)="testConnection()" [loading]="loading" severity="success">Testar Conexão</ub-button>
    <ub-button type="submit" [disabled]="form.invalid" [loading]="loading">Salvar</ub-button>
  </div>
</form>

<div class="test-connection-modal" [class.show]="showTestModal" (click)="closeTestModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <div class="header-icon">
        <i class='bx bx-wifi' [class.testing]="testStatus === 'testing'"
           [class.success]="testStatus === 'success'"
           [class.error]="testStatus === 'error'"></i>
      </div>
      <h3>Teste de Conexão ERP</h3>
      <button class="close-btn" (click)="closeTestModal()">
        <i class='bx bx-x'></i>
      </button>
    </div>

    <!-- Content -->
    <div class="modal-body">
      <!-- Loading State -->
      @if (testStatus === 'testing') {
        <div class="test-loading">
          <div class="spinner"></div>
          <p>Testando conexão...</p>
          <small>Aguarde enquanto verificamos a conectividade com o ERP</small>
        </div>
      }

      <!-- Success State -->
      @if (testStatus === 'success') {
        <div class="test-success">
          <div class="success-icon">
            <i class='bx bx-check-circle'></i>
          </div>
          <h4>Conexão Estabelecida!</h4>
          <p>A conexão com o ERP foi testada com sucesso.</p>
        </div>
      }

      <!-- Error State -->
      @if (testStatus === 'error') {
        <div class="test-error">
          <div class="error-icon">
            <i class='bx bx-error-circle'></i>
          </div>
          <h4>Falha na Conexão</h4>
          <p>{{ testResult?.message || 'Não foi possível conectar ao ERP' }}</p>
          @if (testResult?.details) {
            <div class="error-details">
              <h5>Detalhes do Erro:</h5>
              <p>{{ testResult.details }}</p>
            </div>
          }
          <div class="error-suggestions">
            <h5>Possíveis soluções:</h5>
            <ul>
              <li>Verifique se a URL base está correta</li>
              <li>Confirme se as credenciais estão válidas</li>
              <li>Certifique-se de que o ERP está online</li>
              <li>Verifique sua conexão com a internet</li>
            </ul>
          </div>
        </div>
      }

      <!-- Technical Info -->
      @if (testResult?.data) {
        <div class="technical-info">
          <h5>Informações Técnicas</h5>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Status:</span>
              <span class="info-value" [class.success]="testResult.data.success" [class.error]="!testResult.data.success">
                    {{ testResult.data.success ? 'Sucesso' : 'Falha' }}
                  </span>
            </div>
            <div class="info-item">
              <span class="info-label">Tipo de Autenticação:</span>
              <span class="info-value">{{ testResult.data.auth_type || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Tempo de Resposta:</span>
              <span class="info-value">{{ testResult.data.response_time_ms }} ms</span>
            </div>
            <div class="info-item">
              <span class="info-label">Timestamp:</span>
              <span class="info-value">{{ testResult.data.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}</span>
            </div>
            @if (testResult.data.error) {
              <div class="info-item full-width">
                <span class="info-value error-message">{{ testResult.data.error }}</span>
              </div>
            }
          </div>
        </div>
      }

    </div>

    <!-- Footer -->
    <div class="modal-footer">
      @if (testStatus === 'error') {
        <button class="retry-btn" (click)="retryTest()" [disabled]="testLoading">
          <i class='bx bx-refresh'></i>
          Tentar Novamente
        </button>
      }
      <button class="close-footer-btn" (click)="closeTestModal()">
        Fechar
      </button>
    </div>
  </div>
</div>
